<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CSS Workflow Integration Portal - EKFC</title>
<style>
  :root{
    --ekfc-red:#C8102E; --ekfc-red-dark:#A00E24; --gold:#B8975F;
    --text:#111; --muted:#666; --bg:#f5f5f5; --card:#fff; --line:#ddd; --soft:#f8f8f8;
    --SS:#2f7ed8; --HD:#28a745; --FT:#7b61ff; --MD:#ff6b8b; --II:#0c5460;
    --intake:#ff9a2f; --yellow:#ffd400;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);min-height:100vh;color:var(--text)}
  .header{background:var(--card);border-bottom:3px solid var(--ekfc-red);padding:15px 30px;box-shadow:0 2px 4px rgba(0,0,0,.08)}
  .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
  .header-left{display:flex;align-items:center;gap:20px}
  .logo-text{color:var(--ekfc-red);font-size:24px;font-weight:bold}
  .header h1{font-size:20px;font-weight:normal}
  .header-subtitle{color:var(--muted);font-size:14px}
  .nav-tabs{display:flex;background:var(--card);border-radius:4px;overflow:hidden;border:1px solid var(--line)}
  .nav-tab{background:var(--card);border:none;color:#666;padding:8px 18px;cursor:pointer;font-size:14px;transition:.2s;border-right:1px solid var(--line)}
  .nav-tab:last-child{border-right:none}
  .nav-tab:hover{background:var(--soft)}
  .nav-tab.active{background:var(--ekfc-red);color:#fff}
  .container{max-width:1400px;margin:20px auto;padding:0 20px}
  .content-area{display:none}
  .content-area.active{display:block}

  .panel{background:var(--card);border:1px solid var(--line);border-radius:4px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
  .panel-title{font-size:16px;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid var(--gold);font-weight:600}

  .workflow-container{display:grid;grid-template-columns:380px 1fr;gap:20px}
  .form-group{margin-bottom:15px}
  label{display:block;font-size:13px;font-weight:600;margin-bottom:5px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:3px;font-size:13px}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--ekfc-red)}
  .submit-btn{background:var(--ekfc-red);color:#fff;border:none;padding:10px 20px;border-radius:3px;font-size:14px;font-weight:600;cursor:pointer;width:100%;transition:.2s}
  .submit-btn:hover{background:var(--ekfc-red-dark)}
  .alert{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;margin-bottom:15px;border-radius:3px;font-size:13px;display:none}
  .alert.show{display:block}
  .ticket-info{background:#fff3cd;border:1px solid #ffeeba;color:#856404;padding:10px;margin-top:15px;border-radius:3px;font-size:13px;display:none}
  .ticket-info.show{display:block}
  .ticket-number{font-weight:bold;color:var(--ekfc-red)}

  .resolution-banner{
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border:1px solid #eee;border-left-width:4px;border-radius:6px;background:#fafafa;margin-bottom:12px;
    font-size:13px
  }
  .res-standard{border-left-color:#28a745;background:#f3fbf4}
  .res-high{border-left-color:#ff9a2f;background:#fff6ec}
  .res-urgent{border-left-color:#dc3545;background:#fff1f3}
  .resolution-banner .tag{font-weight:800}
  .resolution-banner .eta{font-weight:700}
  .resolution-banner .muted{color:#666}

  .workflow-step{position:relative;display:flex;padding:15px;margin-bottom:15px;background:var(--soft);border:1px solid #e0e0e0;border-radius:3px;opacity:.5;transition:.3s}
  .workflow-step.active{opacity:1;background:#fff;border-color:var(--ekfc-red);border-width:2px}
  .workflow-step.completed{opacity:.95;background:#f0f8f0;border-color:#28a745}
  .step-number{width:40px;height:40px;background:#ddd;color:#666;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:15px;flex-shrink:0}
  .workflow-step.active .step-number{background:var(--ekfc-red);color:#fff}
  .workflow-step.completed .step-number{background:#28a745;color:#fff}
  .step-content{flex:1}
  .step-title{font-size:14px;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .step-desc{font-size:12px;color:var(--muted)}
  .step-details{margin-top:8px;padding-top:8px;border-top:1px solid #e0e0e0;font-size:11px;color:var(--muted);display:none}
  .workflow-step.active .step-details,.workflow-step.completed .step-details{display:block}

  /* escalation UI */
  .esc-pill{
    display:inline-flex;align-items:center;gap:6px;
    background:#fff1f3;border:1px solid #dc3545;color:#dc3545;
    padding:2px 8px;border-radius:10px;font-size:11px;font-weight:800;cursor:pointer;
  }
  .esc-dot{width:6px;height:6px;border-radius:50%;background:#dc3545;display:inline-block}
  .esc-pop{
    position:absolute;right:16px;top:50px;z-index:5;max-width:380px;
    background:#fff;border:1px solid #f1b5bd;border-left:4px solid #dc3545;
    box-shadow:0 10px 24px rgba(0,0,0,.08);border-radius:8px;padding:10px 12px;font-size:12px;line-height:1.35;display:none
  }
  .esc-pop .h{font-weight:800;margin-bottom:4px}
  .esc-pop .item{display:flex;gap:8px;margin:4px 0}
  .esc-pop .k{min-width:98px;color:#444}
  .esc-pop .v{font-weight:700}
  .esc-close{position:absolute;top:6px;right:8px;border:none;background:transparent;color:#b13a46;cursor:pointer;font-weight:800}

  .dashboard-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
  .metric-card{background:var(--card);border:1px solid var(--line);border-radius:4px;padding:15px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
  .metric-value{font-size:28px;font-weight:bold;color:var(--ekfc-red);margin-bottom:5px}
  .metric-label{font-size:12px;color:var(--muted);text-transform:uppercase}
  .metric-change{font-size:11px;margin-top:5px}
  .positive{color:#28a745}.negative{color:#dc3545}
  .dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  .table{width:100%;border-collapse:collapse;font-size:12px}
  .table th{background:var(--soft);padding:8px;text-align:left;font-weight:600;border-bottom:2px solid var(--gold)}
  .table td{padding:8px;border-bottom:1px solid #e0e0e0;color:#555}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{background:#fff;border:1px solid var(--line);padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn:hover{background:#f9f9f9}
  .live-wrap{background:var(--card);border:1px solid var(--line);border-radius:4px;padding:10px;position:relative}
  .svg-host{width:100%;height:620px;background:#fff;border:1px solid #eee;border-radius:4px;cursor:grab}
  .svg-host.dragging{cursor:grabbing}
  .lane{stroke:#e6e6e6;stroke-width:1}
  .stage rect{fill:#ffffff;stroke:var(--ekfc-red);stroke-width:1.5}
  .stage text{fill:#000;font-size:12px}
  .edge{stroke:#c7c7c7;stroke-width:2;fill:none;marker-end:url(#arrow)}
  .token{filter:drop-shadow(0 1px 4px rgba(0,0,0,.15))}
  .token rect{stroke:#000;stroke-opacity:.15;rx:7;ry:7}
  .token text{fill:#000;font-weight:800;font-size:10px}
  .tip{position:absolute;pointer-events:none;background:#fff;border:1px solid #ddd;border-radius:6px;padding:8px 10px;font-size:12px;box-shadow:0 8px 18px rgba(0,0,0,.08);display:none}
  .tip .t{font-weight:700;margin-bottom:6px}
  .tip .row{display:flex;justify-content:space-between;gap:16px}
  .tip .k{color:#777;text-transform:uppercase;font-size:11px}
  .tip .v{font-weight:700}

  /* priority decorations (step borders) */
  .priority-ribbon{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700}
  .step-urgent{border-color:#dc3545 !important;background:#fff}
  .step-high{border-color:#ff9a2f !important;background:#fff}
  .step-standard{border-color:#28a74522;background:#fff}
  .exclaim{display:inline-block;width:18px;height:18px;line-height:18px;text-align:center;border-radius:50%;background:#dc3545;color:#fff;font-weight:800;margin-left:6px}
</style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <span class="logo-text">Emirates|Flight Catering</span>
        <div>
          <h1>CSS Workflow Integration Portal</h1>
          <div class="header-subtitle">Culinary Shared Services</div>
        </div>
      </div>
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchView('workflow',event)">Workflow (Simple)</button>
        <button class="nav-tab" onclick="switchView('dashboard',event)">VP Dashboard</button>
        <button class="nav-tab" onclick="switchView('live',event)">Workflow (Live)</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Simple Workflow -->
    <div id="workflow-view" class="content-area active">
      <div class="workflow-container">
        <div class="panel">
          <h2 class="panel-title">Submit H&amp;D Request</h2>
          <div id="alert" class="alert">Request submitted successfully. Processing ticket...</div>

          <div class="form-group">
            <label>Requester Name *</label>
            <input type="text" value="Tobias Taubner"/>
          </div>
          <div class="form-group">
            <label>Business Unit *</label>
            <select>
              <option>DIA Lounges</option>
              <option>East Wing Production</option>
              <option>West Wing Production</option>
              <option>Commercial Kitchen</option>
            </select>
          </div>
          <div class="form-group">
            <label>Request Type *</label>
            <select>
              <option>Health Claim Verification</option>
              <option>Allergen Declaration Review</option>
              <option>Nutritional Analysis</option>
              <option>Special Diet Menu Development</option>
            </select>
          </div>
          <div class="form-group">
            <label>Priority *</label>
            <select id="prioritySelect">
              <option value="standard">Standard (≈5 days)</option>
              <option value="high">High (≈3 days)</option>
              <option value="urgent">Urgent (24 hours)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Description *</label>
            <textarea rows="3">Need allergen review for new pasta dish containing nuts and dairy. Menu item planned for Q1 2025 launch.</textarea>
          </div>
          <button class="submit-btn" onclick="submitRequest()">Submit Request</button>

          <div id="ticketInfo" class="ticket-info">
            <strong>Ticket Created</strong><br/>
            <span class="ticket-number">HD-2025-0142</span><br/>
            Track your request using this number
          </div>
        </div>

        <div class="panel">
          <h2 class="panel-title">Workflow Journey</h2>

          <!-- Resolution Target banner -->
          <div id="resBanner" class="resolution-banner res-standard" style="display:none">
            <span class="tag">Resolution target:</span>
            <span id="resTarget" class="eta">≤ 120 hours</span>
            <span class="muted"> (by <span id="resETA">—</span>)</span>
          </div>

          <div class="workflow-step" id="step1">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-title">
                Request Submission
              </div>
              <div class="step-desc">BU submits request through unified portal</div>
              <div class="step-details">
                <strong>Submitted:</strong> <span id="time1">--</span><br/>
                <strong>System:</strong> <b>CSS Workorder Portal</b>
              </div>
            </div>
          </div>

          <div class="workflow-step" id="step2">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-title">
                CSS Admin Intake
                <span id="esc2" class="esc-pill" style="display:none"><span class="esc-dot"></span>Escalation</span>
              </div>
              <div class="step-desc">Request routed to CSS Admin for initial processing</div>
              <div class="step-details" id="sd2"></div>
              <div id="pop2" class="esc-pop">
                <button class="esc-close" data-close="#pop2">×</button>
                <div class="h">Intake escalation</div>
                <div class="item"><div class="k">Notifications</div><div class="v" id="esc2_notif">—</div></div>
                <div class="item"><div class="k">Routing</div><div class="v" id="esc2_route">—</div></div>
                <div class="item"><div class="k">SLA impact</div><div class="v" id="esc2_sla">—</div></div>
              </div>
            </div>
          </div>

          <div class="workflow-step" id="step3">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-title">
                H&amp;D Assignment
                <span id="esc3" class="esc-pill" style="display:none"><span class="esc-dot"></span>Escalation</span>
              </div>
              <div class="step-desc">Ticket assigned to H&amp;D specialist based on expertise</div>
              <div class="step-details" id="sd3"></div>
              <div id="pop3" class="esc-pop">
                <button class="esc-close" data-close="#pop3">×</button>
                <div class="h">Assignment escalation</div>
                <div class="item"><div class="k">Assignee</div><div class="v" id="esc3_assignee">—</div></div>
                <div class="item"><div class="k">Signals</div><div class="v" id="esc3_signals">—</div></div>
                <div class="item"><div class="k">Reminders</div><div class="v" id="esc3_rem">—</div></div>
              </div>
            </div>
          </div>

          <div class="workflow-step" id="step4">
            <div class="step-number">4</div>
            <div class="step-content">
              <div class="step-title">
                Technical Review
                <span id="esc4" class="esc-pill" style="display:none"><span class="esc-dot"></span>Escalation</span>
              </div>
              <div class="step-desc">H&amp;D specialist performs allergen assessment</div>
              <div class="step-details" id="sd4"></div>
              <div id="pop4" class="esc-pop">
                <button class="esc-close" data-close="#pop4">×</button>
                <div class="h">Technical review escalation</div>
                <div class="item"><div class="k">Priority</div><div class="v" id="esc4_pri">—</div></div>
                <div class="item"><div class="k">Reminders</div><div class="v" id="esc4_rem">—</div></div>
                <div class="item"><div class="k">Channels</div><div class="v" id="esc4_ch">—</div></div>
              </div>
            </div>
          </div>

          <div class="workflow-step" id="step5">
            <div class="step-number">5</div>
            <div class="step-content">
              <div class="step-title">
                Manager Approval &amp; Review
                <span id="esc5" class="esc-pill" style="display:none"><span class="esc-dot"></span>Escalation</span>
              </div>
              <div class="step-desc">Manager review and approval</div>
              <div class="step-details" id="sd5"></div>
              <div id="pop5" class="esc-pop">
                <button class="esc-close" data-close="#pop5">×</button>
                <div class="h">Approval escalation</div>
                <div class="item"><div class="k">Approver</div><div class="v" id="esc5_appr">—</div></div>
                <div class="item"><div class="k">Notifications</div><div class="v" id="esc5_notif">—</div></div>
                <div class="item"><div class="k">Deadline guards</div><div class="v" id="esc5_guard">—</div></div>
              </div>
            </div>
          </div>

          <div class="workflow-step" id="step6">
            <div class="step-number">6</div>
            <div class="step-content">
              <div class="step-title">Delivery</div>
              <div class="step-desc">Results delivered to requester</div>
              <div class="step-details">
                <strong>Format:</strong> <b>Email</b><br/>
                <strong>Channel:</strong> <b>Outlook 365</b>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- VP Dashboard (sample numbers) -->
    <div id="dashboard-view" class="content-area">
      <div class="dashboard-metrics">
        <div class="metric-card"><div class="metric-value">37</div><div class="metric-label">Total Active Requests</div><div class="metric-change positive">Stable (target ≤ 40)</div></div>
        <div class="metric-card"><div class="metric-value">94%</div><div class="metric-label">SLA Compliance</div><div class="metric-change positive">↑ 3% improvement</div></div>
        <div class="metric-card"><div class="metric-value">3.2</div><div class="metric-label">Avg Days to Complete</div><div class="metric-change positive">↓ 0.5 days faster</div></div>
        <div class="metric-card"><div class="metric-value">18.5</div><div class="metric-label">Avg Hours per Request</div><div class="metric-change negative">↑ 2.1 hours</div></div>
        <div class="metric-card"><div class="metric-value">89%</div><div class="metric-label">First-Pass Acceptance</div><div class="metric-change positive">↑ 5% improvement</div></div>
      </div>
    </div>

    <!-- Live Workflow -->
    <div id="live-view" class="content-area">
      <div class="panel">
        <h2 class="panel-title">Live Flow • CSS Journey</h2>
        <div class="toolbar">
          <button class="btn" id="btnPlay">Pause</button>
          <button class="btn" id="btnZoomIn">Zoom +</button>
          <button class="btn" id="btnZoomOut">Zoom −</button>
          <button class="btn" id="btnReset">Reset</button>
          <button class="btn" id="btnSubmitDemo">New Request (Demo)</button>
          <select id="livePriority" class="btn" style="min-width:170px">
            <option value="standard">Priority: Standard</option>
            <option value="high">Priority: High</option>
            <option value="urgent">Priority: Urgent</option>
          </select>
        </div>
        <div class="live-wrap" id="liveWrap">
          <div id="tip" class="tip"></div>
          <svg id="svg" class="svg-host" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet">
            <defs>
              <marker id="arrow" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
                <polygon points="0,0 10,4 0,8" fill="#c7c7c7"></polygon>
              </marker>
            </defs>
            <g id="zoomRoot" transform="translate(0,0) scale(1)">
              <g class="lane">
                <line x1="80" y1="120" x2="1120" y2="120"/>
                <line x1="80" y1="240" x2="1120" y2="240"/>
                <line x1="80" y1="360" x2="1120" y2="360"/>
                <line x1="80" y1="480" x2="1120" y2="480"/>
                <line x1="80" y1="600" x2="1120" y2="600"/>
              </g>

              <g id="stages" class="stage">
                <g data-key="INTAKE"><rect x="520" y="80" width="160" height="50" rx="8"/><text x="600" y="110" text-anchor="middle">Unified Intake • CSS Portal</text></g>
                <g data-key="ROUTER"><rect x="520" y="200" width="160" height="50" rx="8"/><text x="600" y="230" text-anchor="middle">Router</text></g>

                <g data-key="SS_COORD"><rect x="140" y="320" width="180" height="50" rx="8"/><text x="230" y="350" text-anchor="middle">S&amp;S Coordinator</text></g>
                <g data-key="HD_COORD"><rect x="380" y="320" width="180" height="50" rx="8"/><text x="470" y="350" text-anchor="middle">H&amp;D Coordinator</text></g>
                <g data-key="FT_COORD"><rect x="620" y="320" width="180" height="50" rx="8"/><text x="710" y="350" text-anchor="middle">FoodTech Coordinator</text></g>
                <g data-key="MD_COORD"><rect x="860" y="320" width="180" height="50" rx="8"/><text x="950" y="350" text-anchor="middle">MenuDev Coordinator</text></g>

                <g data-key="SS_A"><rect x="140" y="440" width="160" height="46" rx="8"/><text x="220" y="468" text-anchor="middle">S&amp;S • A</text></g>
                <g data-key="SS_B"><rect x="200" y="520" width="160" height="46" rx="8"/><text x="280" y="548" text-anchor="middle">S&amp;S • B</text></g>
                <g data-key="HD_A"><rect x="380" y="440" width="160" height="46" rx="8"/><text x="460" y="468" text-anchor="middle">H&amp;D • A</text></g>
                <g data-key="HD_B"><rect x="440" y="520" width="160" height="46" rx="8"/><text x="520" y="548" text-anchor="middle">H&amp;D • B</text></g>
                <g data-key="FT_A"><rect x="620" y="440" width="160" height="46" rx="8"/><text x="700" y="468" text-anchor="middle">FT • A</text></g>
                <g data-key="FT_B"><rect x="680" y="520" width="160" height="46" rx="8"/><text x="760" y="548" text-anchor="middle">FT • B</text></g>
                <g data-key="MD_A"><rect x="860" y="440" width="160" height="46" rx="8"/><text x="940" y="468" text-anchor="middle">MD • A</text></g>
                <g data-key="MD_B"><rect x="920" y="520" width="160" height="46" rx="8"/><text x="1000" y="548" text-anchor="middle">MD • B</text></g>

                <g data-key="DONE"><rect x="520" y="620" width="160" height="50" rx="8"/><text x="600" y="650" text-anchor="middle">Delivery &amp; Done</text></g>
              </g>

              <g class="edge">
                <path d="M600,130 L600,200"/>
                <path d="M600,250 L230,320"/><path d="M600,250 L470,320"/><path d="M600,250 L710,320"/><path d="M600,250 L950,320"/>
                <path d="M230,370 L220,440"/><path d="M230,370 L280,520"/>
                <path d="M470,370 L460,440"/><path d="M470,370 L520,520"/>
                <path d="M710,370 L700,440"/><path d="M710,370 L760,520"/>
                <path d="M950,370 L940,440"/><path d="M950,370 L1000,520"/>
                <path d="M220,486 L600,620"/><path d="M280,566 L600,620"/>
                <path d="M460,486 L600,620"/><path d="M520,566 L600,620"/>
                <path d="M700,486 L600,620"/><path d="M760,566 L600,620"/>
                <path d="M940,486 L600,620"/><path d="M1000,566 L600,620"/>
              </g>

              <g id="tokens"></g>
              <g id="labels"></g>
            </g>
          </svg>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Tabs ===== */
function switchView(view, event){
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.content-area').forEach(a=>a.classList.remove('active'));
  document.getElementById(view+'-view').classList.add('active');
}

/* ===== Priority model =====
   Baseline total SLA = 120h (≈5 days). High=72h, Urgent=24h. */
const PRIORITY = {
  standard: { name:'Standard', color:'#28a745', accent:'#f3fbf4', factor:1.0, targetH:120, escalate:false, notifyMgr:false },
  high:     { name:'High',     color:'#ff9a2f', accent:'#fff6ec', factor:0.6, targetH:72,  escalate:true,  notifyMgr:true },
  urgent:   { name:'Urgent',   color:'#dc3545', accent:'#fff1f3', factor:0.2, targetH:24,  escalate:true,  notifyMgr:true, fastTrackFC09:true }
};
let currentPriority = PRIORITY.standard;

/* ===== Simple Workflow ===== */
const baseSLA = { intake:24, assign:48, tech:24, mgr:24 }; // hours; sums to 120h

function submitRequest(){
  const sel = document.getElementById('prioritySelect').value;
  currentPriority = PRIORITY[sel] || PRIORITY.standard;

  document.getElementById('alert').classList.add('show');
  setTimeout(()=>{
    document.getElementById('ticketInfo').classList.add('show');
    startWorkflow(currentPriority);
  }, 600);
}

function addHours(d, hrs){ const dt = new Date(d.getTime()); dt.setHours(dt.getHours() + hrs); return dt; }
function fmtDT(d){ return d.toLocaleString([], {hour12:false}); }

/* Build and wire escalation popups for the four steps */
function updateEscalations(p){
  const isEsc = (p===PRIORITY.high || p===PRIORITY.urgent);

  // show/hide pills
  ['esc2','esc3','esc4','esc5'].forEach(id=>{
    document.getElementById(id).style.display = isEsc ? 'inline-flex' : 'none';
  });

  // Intake details
  document.getElementById('esc2_notif').textContent =
    p===PRIORITY.urgent ? 'Mgr + Senior Mgr (Email & MS Teams, immediate)' :
    'Mgr (Email & MS Teams, immediate)';
  document.getElementById('esc2_route').textContent =
    p===PRIORITY.urgent ? 'Fast route with priority flag' : 'Priority flag in queue';
  document.getElementById('esc2_sla').textContent =
    `Step window: ${Math.max(1, Math.round(baseSLA.intake*p.factor))}h`;

  // Assignment details
  document.getElementById('esc3_assignee').textContent =
    p.fastTrackFC09 ? 'FC09 • Senior Specialist (auto-assigned)' : 'Senior pool highlighted to coordinator';
  document.getElementById('esc3_signals').textContent =
    p.fastTrackFC09 ? 'Pager/Teams alert to FC09 + coordinator' : 'Teams alert to coordinator & senior pool';
  document.getElementById('esc3_rem').textContent =
    p===PRIORITY.urgent ? 'Reminders every 60 min until accepted' : 'Reminders every 2 hours';
  
  // Technical review details
  document.getElementById('esc4_pri').textContent =
    p===PRIORITY.urgent ? 'Marked URGENT in reviewer’s queue' : 'Marked HIGH in reviewer’s queue';
  document.getElementById('esc4_rem').textContent =
    p===PRIORITY.urgent ? 'SLA guard: T-6h, T-3h, T-1h alerts' : 'SLA guard: T-12h, T-6h alerts';
  document.getElementById('esc4_ch').textContent = 'Email + MS Teams (channel mention)';

  // Manager approval details
  document.getElementById('esc5_appr').textContent =
    p===PRIORITY.urgent ? 'Senior manager (auto-CC, can approve)' : 'Manager (auto-CC senior for visibility)';
  document.getElementById('esc5_notif').textContent =
    p===PRIORITY.urgent ? 'Email + Teams + mobile push (if enabled)' : 'Email + Teams';
  document.getElementById('esc5_guard').textContent =
    p===PRIORITY.urgent ? 'Deadline guards: T-4h, T-2h, T-30m' : 'Deadline guards: T-12h, T-4h';

  // click handlers to toggle popups
  [['esc2','pop2'],['esc3','pop3'],['esc4','pop4'],['esc5','pop5']].forEach(([pill,pop])=>{
    const pillEl = document.getElementById(pill);
    const popEl  = document.getElementById(pop);
    pillEl.onclick = (e)=>{ e.stopPropagation(); closeAllPops(); popEl.style.display='block'; };
  });
  document.querySelectorAll('.esc-close').forEach(btn=>{
    btn.onclick = (e)=>{ const id=e.target.getAttribute('data-close'); document.querySelector(id).style.display='none'; e.stopPropagation(); };
  });
  document.addEventListener('click', closeAllPops);
}
function closeAllPops(){ document.querySelectorAll('.esc-pop').forEach(p=>p.style.display='none'); }

function startWorkflow(p){
  const steps = [...document.querySelectorAll('#workflow-view .workflow-step')];
  steps.forEach(s => { s.classList.remove('active','completed','step-urgent','step-high','step-standard'); });

  // Resolution target banner
  const totalTarget = p.targetH;
  const eta = fmtDT(addHours(new Date(), totalTarget));
  const banner = document.getElementById('resBanner');
  banner.style.display = 'flex';
  banner.classList.remove('res-standard','res-high','res-urgent');
  banner.classList.add(p===PRIORITY.urgent?'res-urgent':p===PRIORITY.high?'res-high':'res-standard');
  document.getElementById('resTarget').textContent = `≤ ${totalTarget} hours`;
  document.getElementById('resETA').textContent = eta;

  // Scaled per-step SLAs for display
  const f = p.factor;
  const s2 = Math.max(1, Math.round(baseSLA.intake*f));
  const s3 = Math.max(1, Math.round(baseSLA.assign*f));
  const s4 = Math.max(1, Math.round(baseSLA.tech*f));
  const s5 = Math.max(1, Math.round(baseSLA.mgr*f));

  document.getElementById('sd2').innerHTML =
    `<strong>SLA:</strong> <b>${s2} hours</b><br/><strong>Status:</strong> Processing` +
    (p.notifyMgr ? ` <span class="priority-ribbon" style="background:${p.accent};color:${p.color}">Mgr notified</span>`:``);

  document.getElementById('sd3').innerHTML =
    `<strong>SLA:</strong> <b>Processing within ${s3} hours</b><br/>` +
    `<strong>Assigned to:</strong> ${p.fastTrackFC09 ? 'FC09 • Senior Specialist (Auto)' : 'Sarah Johnson'}`;

  document.getElementById('sd4').innerHTML =
    `<strong>SLA:</strong> <b>${s4} hours</b><br/><strong>Compliance:</strong> EU & UAE standards`;

  document.getElementById('sd5').innerHTML =
    `<strong>SLA:</strong> <b>${s5} hours</b><br/><strong>Checklist:</strong> Complete`;

  // Priority step skins + labels
  const skin = p === PRIORITY.urgent ? 'step-urgent' : p === PRIORITY.high ? 'step-high' : 'step-standard';
  steps.forEach(s => s.classList.add(skin));
  const title2 = document.querySelector('#step2 .step-title');
  title2.innerHTML = `CSS Admin Intake${
    p.escalate ? ` <span class="priority-ribbon" style="background:${p.accent};color:${p.color}">${p.name}</span>` : ''
  }${p === PRIORITY.urgent ? ` <span class="exclaim">!</span>`:''}
  <span id="esc2" class="esc-pill" style="display:${(p===PRIORITY.high||p===PRIORITY.urgent)?'inline-flex':'none'}"><span class="esc-dot"></span>Escalation</span>`;

  // ensure other pills persist after title rewrite
  document.getElementById('esc3').style.display = (p===PRIORITY.high||p===PRIORITY.urgent)?'inline-flex':'none';
  document.getElementById('esc4').style.display = (p===PRIORITY.high||p===PRIORITY.urgent)?'inline-flex':'none';
  document.getElementById('esc5').style.display = (p===PRIORITY.high||p===PRIORITY.urgent)?'inline-flex':'none';

  // Build escalation copy + handlers
  updateEscalations(p);

  // Animation timings (ms) scaled by factor
  const t=[0, 2000*f, 4000*f, 6000*f, 8000*f, 10000*f];
  if (p.fastTrackFC09){ t[1]=400*f; t[2]=1200*f; }

  setTimeout(()=>{activateStep(steps,0); document.getElementById('time1').textContent=new Date().toLocaleTimeString();}, t[0]);
  setTimeout(()=>{nextStep(steps,0,1);}, t[1]);
  setTimeout(()=>{nextStep(steps,1,2);}, t[2]);
  setTimeout(()=>{nextStep(steps,2,3);}, t[3]);
  setTimeout(()=>{nextStep(steps,3,4);}, t[4]);
  setTimeout(()=>{nextStep(steps,4,5); setTimeout(()=>finishStep(steps,5), 800*f);}, t[5]);

  function activateStep(steps,i){ steps[i].classList.add('active'); }
  function nextStep(steps,i,j){ steps[i].classList.remove('active'); steps[i].classList.add('completed'); steps[j].classList.add('active'); }
  function finishStep(steps,i){ steps[i].classList.remove('active'); steps[i].classList.add('completed'); }
}

/* ===== Live Workflow (priority still affects speed/colors) ===== */
const svg = document.getElementById('svg');
const root = document.getElementById('zoomRoot');
const tokensLayer = document.getElementById('tokens');
const labelsLayer = document.getElementById('labels');
const tip = document.getElementById('tip');
const host = document.getElementById('svg');

let playing=true, scale=1, panX=0, panY=0;
document.getElementById('btnPlay').onclick=()=>{ playing=!playing; document.getElementById('btnPlay').textContent=playing?'Pause':'Play'; };
document.getElementById('btnZoomIn').onclick=()=>{ zoomAt(1.1); };
document.getElementById('btnZoomOut').onclick=()=>{ zoomAt(0.9); };
document.getElementById('btnReset').onclick=resetFlow;
document.getElementById('btnSubmitDemo').onclick=()=> spawnNewToken();
document.getElementById('livePriority').onchange = (e)=>{ currentPriority = PRIORITY[e.target.value] || PRIORITY.standard; };

function applyTransform(){ root.setAttribute('transform',`translate(${panX},${panY}) scale(${scale})`); }
function zoomAt(f){ scale=Math.min(1.8,Math.max(0.7,scale*f)); applyTransform(); }

let dragging=false, lastX=0, lastY=0;
host.addEventListener('mousedown',e=>{dragging=true; lastX=e.clientX; lastY=e.clientY; host.classList.add('dragging');});
window.addEventListener('mouseup',()=>{dragging=false; host.classList.remove('dragging');});
window.addEventListener('mousemove',e=>{
  if(!dragging) return;
  const dx=e.clientX-lastX, dy=e.clientY-lastY; panX+=dx; panY+=dy; lastX=e.clientX; lastY=e.clientY; applyTransform();
});

const N = {
  intake:{x:600,y:105}, router:{x:600,y:225},
  SS:{coord:{x:230,y:345}, A:{x:220,y:463}, B:{x:280,y:543}, color:getCSS('--SS')},
  HD:{coord:{x:470,y:345}, A:{x:460,y:463}, B:{x:520,y:543}, color:getCSS('--HD')},
  FT:{coord:{x:710,y:345}, A:{x:700,y:463}, B:{x:760,y:543}, color:getCSS('--FT')},
  MD:{coord:{x:950,y:345}, A:{x:940,y:463}, B:{x:1000,y:543}, color:getCSS('--MD')},
  done:{x:600,y:645}
};
function getCSS(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function label(text,x,y,fill='#fff',bg='#000',ms=900){
  const g=doc('g'); if (labelsLayer.childElementCount > 16) { return; }
  const r=doc('rect'), t=doc('text');
  t.textContent=text; t.setAttribute('x',x); t.setAttribute('y',y-16); t.setAttribute('text-anchor','middle'); t.setAttribute('fill',fill);
  t.setAttribute('font-size','11'); t.setAttribute('font-weight','700');
  const w=Math.max(60,text.length*7+12), h=20;
  r.setAttribute('x',x-w/2); r.setAttribute('y',y-16-h+6); r.setAttribute('width',w); r.setAttribute('height',h);
  r.setAttribute('rx','8'); r.setAttribute('fill',bg); r.setAttribute('opacity','0.92');
  g.append(r,t); labelsLayer.appendChild(g); setTimeout(()=>g.remove(),ms);
}
function doc(tag){return document.createElementNS(svg.namespaceURI,tag);}
function setPos(node,x,y){ node.rect.setAttribute('x',x-26); node.rect.setAttribute('y',y-11); node.text.setAttribute('x',x); node.text.setAttribute('y',y+3); }
function setColor(node,phase,branchColor){
  let fill = getCSS('--yellow');
  if(phase==='intake') fill = currentPriority.accent || getCSS('--intake');
  if(phase==='branch') fill = branchColor;
  if(currentPriority === PRIORITY.high && phase!=='branch') fill = '#fff6ec';
  if(currentPriority === PRIORITY.urgent && phase!=='branch') fill = '#fff1f3';
  node.rect.setAttribute('fill', fill);
  node.rect.setAttribute('stroke', currentPriority.color);
  node.rect.setAttribute('stroke-width', 1.2);
}

function timeline(branch){
  const f = (currentPriority?.factor) || 1;
  const badgeEsc = currentPriority.escalate ? 'Escalated' : null;
  const mgrNote  = currentPriority.notifyMgr ? 'Senior mgr CC' : null;

  const tl = [
    {p:N.intake, hold:900*f,  travel:0,       phase:'intake', badge: mgrNote},
    {p:N.router, hold:700*f,  travel:3200*f,  phase:'yellow', badge: badgeEsc},
    {p:N[branch].coord,  hold:800*f,  travel:3800*f,  phase:'branch'},
    {p:N[branch].A,      hold:2400*f, travel:1800*f,  phase:'branch', badge:'In progress'},
    {p:N[branch].B,      hold:1200*f, travel:1600*f,  phase:'branch'},
    {p:N.done,           hold:800*f,  travel:2100*f,  phase:'branch', complete:true}
  ];

  if (currentPriority.fastTrackFC09){
    tl[0].hold = 300*f; tl[1].travel = 900*f; tl[2].hold = 400*f; tl[3].badge = 'FC09 assigned';
  }
  return tl;
}

const tokens=[];
function newToken(id, branchKey){
  const g=doc('g'); g.classList.add('token'); g.setAttribute('data-id',id);
  const r=doc('rect'); r.setAttribute('width',52); r.setAttribute('height',22);
  const t=doc('text'); t.setAttribute('text-anchor','middle'); t.textContent=id.split('-')[0];
  g.append(r,t); tokensLayer.appendChild(g);
  const tl=timeline(branchKey); const tok={id,branch:branchKey,color:N[branchKey].color,node:{g,rect:r,text:t},tl,idx:0,alive:true};
  setPos(tok.node, tl[0].p.x, tl[0].p.y); setColor(tok.node,'intake',tok.color);
  label('New request', tl[0].p.x, tl[0].p.y, '#000', getCSS('--intake'), 900);
  tokens.push(tok); return tok;
}
function spawnNewToken(){
  const branches=['SS','HD','FT','MD'];
  const b=branches[Math.floor(Math.random()*branches.length)];
  const id=b+'-'+(1000+Math.floor(Math.random()*9000));
  newToken(id,b);
}

const STATS={
  INTAKE:{t:'Unified Intake',r:[['Avg triage','12m'],['Today','9'],['Rejections','0']]},
  ROUTER:{t:'Router',r:[['Auto-route','88%'],['Manual','12%'],['Queue','6']]},
  SS_COORD:{t:'S&S Coord',r:[['SLA','96%'],['Backlog','2'],['Avg time/req','18.2h']]},
  HD_COORD:{t:'H&D Coord',r:[['SLA','93%'],['Backlog','3'],['Avg time/req','15.1h']]},
  FT_COORD:{t:'FoodTech Coord',r:[['SLA','91%'],['Backlog','1'],['Avg time/req','22.3h']]},
  MD_COORD:{t:'MenuDev Coord',r:[['SLA','89%'],['Backlog','4'],['Avg time/req','17.6h']]},
  SS_A:{t:'S&S • A',r:[['WIP','2'],['Throughput/wk','11'],['Avg time/req','19.4h']]},
  SS_B:{t:'S&S • B',r:[['WIP','1'],['Throughput/wk','9'],['Avg time/req','20.1h']]},
  HD_A:{t:'H&D • A',r:[['WIP','2'],['Throughput/wk','7'],['Avg time/req','15.0h']]},
  HD_B:{t:'H&D • B',r:[['WIP','1'],['Throughput/wk','8'],['Avg time/req','16.3h']]},
  FT_A:{t:'FT • A',r:[['WIP','2'],['Tests/wk','6'],['Avg time/req','24.8h']]},
  FT_B:{t:'FT • B',r:[['WIP','1'],['Tests/wk','5'],['Avg time/req','23.1h']]},
  MD_A:{t:'MD • A',r:[['WIP','2'],['Menus/wk','4'],['Avg time/req','18.0h']]},
  MD_B:{t:'MD • B',r:[['WIP','1'],['Menus/wk','3'],['Avg time/req','18.7h']]},
  DONE:{t:'Delivery & Done',r:[['On-time','96%'],['Rollbacks','0'],['Handovers','9']]}
};
document.querySelectorAll('#stages g[data-key]').forEach(el=>{
  const k=el.getAttribute('data-key');
  el.addEventListener('mousemove',e=>{
    const s=STATS[k]; if(!s) return;
    tip.innerHTML=`<div class="t">${s.t}</div>` + s.r.map(([a,b])=>`<div class="row"><div class="k">${a}</div><div class="v">${b}</div></div>`).join('');
    tip.style.left=(e.clientX+14)+'px'; tip.style.top=(e.clientY+14)+'px'; tip.style.display='block';
  });
  el.addEventListener('mouseleave',()=> tip.style.display='none');
});

function animate(ts){
  requestAnimationFrame(animate);
  if(!playing) return;
  if(!animate.last) animate.last=ts;
  const dt=ts-animate.last; animate.last=ts;

  tokens.forEach(tok=>{
    if(!tok.alive) return;
    const seg=tok.tl[tok.idx], next=tok.tl[tok.idx+1];
    if(seg.hold>0){ seg.hold-=dt; if(seg.hold<=0 && seg.badge){ label(seg.badge, seg.p.x, seg.p.y, '#fff', tok.color, 900); } return; }
    seg.elapsed=(seg.elapsed||0)+dt;
    const u=Math.min(1, seg.travel? seg.elapsed/seg.travel : 1);
    const x=next ? seg.p.x + (next.p.x - seg.p.x)*u : seg.p.x;
    const y=next ? seg.p.y + (next.p.y - seg.p.y)*u : seg.p.y;
    setColor(tok.node, seg.phase==='branch'?'branch':(seg.phase==='intake'?'intake':'yellow'), tok.color);
    setPos(tok.node,x,y);
    if(u>=1){
      tok.idx++;
      if(tok.idx>=tok.tl.length-1){
        label('✓ Complete', N.done.x, N.done.y, '#fff', '#28a745', 900);
        tok.node.g.remove(); tok.alive=false;
        setTimeout(()=>{ if(tokens.filter(t=>t.alive).length<10) spawnNewToken(); }, 800+Math.random()*1000);
      }
    }
  });
}
requestAnimationFrame(animate);

function resetFlow(){
  scale=1; panX=0; panY=0; applyTransform();
  animate.last=null;
  [...tokensLayer.children].forEach(n=>n.remove());
  [...labelsLayer.children].forEach(n=>n.remove());
  tokens.length=0;
  ['HD','SS','MD','FT'].forEach((b,i)=> setTimeout(()=> newToken(b+'-'+(2000+i), b), i*650));
}
resetFlow();
</script>
</body>
</html>
